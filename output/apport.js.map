{
  "version": 3,
  "sources": ["../src/apport.ts"],
  "sourcesContent": ["type Swap = \"inner\"|\"replace\"|\"before\"|\"after\"|\"first\"|\"last\"|\"delete\"|\"none\";\r\n\r\ntype ApportOptions={\r\n  method?:\"GET\"|\"POST\"|\"PUT\"|\"DELETE\",\r\n  url?:string,\r\n  form?:string|HTMLFormElement,\r\n  validate?:boolean,\r\n  target?:string|HTMLElement,\r\n  swap?:Swap,\r\n  data?:string,\r\n  trigger?:string,\r\n  triggerName?:string\r\n};\r\n\r\n\r\n// tp=get/post/postback, cmd=cmd/url\r\nasync function Apport(fo:ApportOptions) {\r\n  function ThrowThis(evtDet:ApportOptions,err:Error) {\r\n    document.dispatchEvent(new CustomEvent(\"ap-error\",{detail:{error:err,...evtDet}}));\r\n    throw err;\r\n  }\r\n  \r\n  let evtDet:ApportOptions={...fo};\r\n  if(!fo.method) fo.method=\"GET\";\r\n  if(!fo.url) fo.url=window.location.href;\r\n\r\n  let postBody:FormData|URLSearchParams;\r\n  if(fo.method==\"POST\"||fo.method==\"PUT\") {\r\n    if(fo.form && fo.form!==\"none\") {\r\n      if(typeof fo.form==\"string\") fo.form=<HTMLFormElement>document.querySelector(fo.form);\r\n      if(fo.validate && !fo.form.reportValidity()) return;\r\n      postBody=new FormData(fo.form);\r\n    } else {\r\n      postBody=new FormData();\r\n    }\r\n    let HasFile=false;\r\n    for(const kv of postBody) {\r\n      if(kv[1] instanceof File) { \r\n        HasFile=true;\r\n        break;\r\n      }\r\n    }  \r\n    if(!HasFile) postBody=new URLSearchParams(<any>postBody);\r\n  }\r\n\r\n  document.dispatchEvent(new CustomEvent(\"ap-begin\",{detail:evtDet}));\r\n\r\n  let fo2:any={\r\n    method:(fo.method),\r\n    headers:{ \"AP-Request\":\"true\"},\r\n    redirect:\"error\"\r\n  }\r\n  if(fo.data!==undefined) fo2.headers[\"AP-Data\"]=encodeURI(JSON.stringify(fo.data));\r\n  if(fo.trigger) fo2.headers[\"AP-Trigger\"]=encodeURI(fo.trigger);\r\n  if(fo.triggerName) fo2.headers[\"AP-Trigger-Name\"]=encodeURI(fo.triggerName);\r\n  if(fo.method==\"POST\"||fo.method==\"PUT\") fo2.body=postBody;\r\n\r\n  let r;\r\n  try {\r\n    r = await fetch(fo.url,fo2);\r\n  } catch(err) {\r\n    ThrowThis(evtDet,err);\r\n  }\r\n\r\n  // ------ custom response headers: ----\r\n  let hv;\r\n  if(hv = r.headers.get(\"AP-redirect\")) {\r\n    location.href=hv;\r\n    return;\r\n  }\r\n  if(r.headers.get(\"AP-reload\")===\"true\") {\r\n    location.reload();\r\n    return;\r\n  }\r\n\r\n  if(r.status>=200 && r.status<=202) {\r\n    // OK - insert received content\r\n    if(hv=r.headers.get(\"AP-swap\")) fo.swap=<Swap>hv;\r\n    evtDet.swap=fo.swap;\r\n\r\n    let tEl:HTMLElement;\r\n    if(fo.swap!=\"none\") {\r\n      if(hv=r.headers.get(\"AP-target\")) fo.target=hv;\r\n      if(!fo.target) ThrowThis(evtDet,new Error(\"Missing target\"));\r\n      evtDet.target=fo.target;\r\n      if(typeof fo.target===\"string\") {\r\n        tEl=<HTMLElement>document.querySelector(fo.target);\r\n        if(!tEl) ThrowThis(evtDet,new Error(\"Element of AP-Target header not found: \" + fo.target));\r\n      } else {\r\n        tEl=fo.target;\r\n      }\r\n    }\r\n\r\n    let frag:DocumentFragment;\r\n    if(fo.swap!=\"none\" && fo.swap!=\"delete\") {\r\n      let tmpl=document.createElement('template');\r\n      tmpl.innerHTML=await r.text();\r\n      frag=tmpl.content; \r\n      // we need to re-create all the script tags for these to run / be available\r\n      let scripts=frag.querySelectorAll(\"script\");\r\n      for(const sc of scripts) {\r\n        let ns=document.createElement(\"script\");\r\n        for(const attr of sc.attributes) ns.setAttribute(attr.name,attr.value);\r\n        ns.innerHTML=sc.innerHTML;\r\n        sc.parentNode.replaceChild(ns,sc);\r\n      }\r\n    }\r\n\r\n    switch(fo.swap ?? 'inner') {\r\n      case 'inner':\r\n        tEl.innerHTML=\"\";\r\n        tEl.appendChild(frag);\r\n        break;\r\n      case 'first':\r\n        if(tEl.firstChild) {\r\n          tEl.insertBefore(frag,tEl.firstChild);\r\n        } else {\r\n          tEl.appendChild(frag);\r\n        }\r\n        break;\r\n      case 'last':\r\n        tEl.appendChild(frag);\r\n        break;\r\n      case 'replace':\r\n        tEl.parentNode.replaceChild(frag,tEl);\r\n        break;\r\n      case 'before':\r\n        tEl.parentNode.insertBefore(frag,tEl);\r\n        break;\r\n      case 'after':\r\n        if(tEl.nextSibling) {\r\n          tEl.parentNode.insertBefore(frag,tEl.nextSibling);\r\n        } else {\r\n          tEl.parentNode.appendChild(frag);\r\n        }         \r\n        break;\r\n      case 'delete':\r\n        tEl.remove();\r\n        break;\r\n      case 'none':\r\n        // nothing\r\n        break;\r\n      default:\r\n        ThrowThis(evtDet,new Error(\"Invalid swap value: \" + fo.swap));\r\n    } \r\n\r\n  } else if (r.status===204) {\r\n    // 204 = no content = swap=none\r\n\r\n  } else {\r\n    // status code not supported\r\n    ThrowThis(evtDet,new Error(\"Unsupported response status code received: \" + r.status));\r\n  }\r\n\r\n  // ------ more custom response headers: ----\r\n  if(hv=r.headers.get(\"AP-push-url\")) {\r\n    window.history.pushState(null,\"\",hv);\r\n  }\r\n  if(hv=r.headers.get(\"AP-replace-url\")) {\r\n    window.history.replaceState(null,\"\",hv);\r\n  }\r\n  if(hv=r.headers.get(\"AP-execute\")) {\r\n    let f=new Function(\"$opt\", decodeURIComponent(hv));\r\n    f(evtDet);\r\n  }\r\n\r\n  document.dispatchEvent(new CustomEvent(\"ap-done\",{detail:evtDet}));\r\n}\r\n\r\n\r\nfunction HookUpElem(el:HTMLElement,tp:string) {\r\n  function MakeOpt() {\r\n    let rv:ApportOptions={}; \r\n    //-- method/url --\r\n    rv.method=<any>tp.toUpperCase();\r\n    let AttrVal=el.getAttribute(\"ap-\"+tp);\r\n    if(AttrVal) rv.url=AttrVal;  \r\n    // -- ap-swap --\r\n    rv.swap=<Swap>el.getAttribute(\"ap-swap\") ?? undefined;\r\n    // -- ap-validate --\r\n    rv.validate=el.hasAttribute(\"ap-validate\");\r\n    // -- ap-target --\r\n    rv.target= el.getAttribute(\"ap-target\") ?? el;\r\n    // -- ap-data --\r\n    var dataJS=el.getAttribute(\"ap-data\");\r\n    if(dataJS) {\r\n      let f=new Function(\"return \" + dataJS);\r\n      try {\r\n        rv.data=f();\r\n      } catch(err) {\r\n        throw new Error(\"Error evaluating ap-data attribute value (\\\"\" + dataJS + \"\\\") on \" + el.tagName + \" element \" + (el.id ? \"#\" + el.id :\"\"),{cause:err});\r\n      }\r\n    }\r\n\r\n    rv.trigger=el.id ?? undefined;\r\n    rv.triggerName=el.getAttribute(\"name\") ?? undefined;\r\n    // form\r\n    if(tp==\"POST\"||tp==\"PUT\") rv.form=el.closest(\"form\") ?? undefined;\r\n    return rv; \r\n  }\r\n\r\n  // -- ap-on --\r\n  let EvtName:string=null;\r\n  if(el.hasAttribute(\"ap-on\")) {\r\n    EvtName=el.getAttribute(\"ap-on\");\r\n  } else {\r\n    let tagName = el.tagName.toLowerCase();\r\n    EvtName=([\"input\",\"textarea\",\"select\"].indexOf(tagName)>=0 ? \"change\" : (tagName===\"form\" ? \"submit\" : \"click\"));\r\n  }\r\n  if(EvtName===\"mount\") {\r\n    Apport(MakeOpt()); //TODO: maybe wait tick?\r\n  } else {\r\n    el.addEventListener(EvtName,(evt:Event)=>{evt.preventDefault();Apport(MakeOpt());});\r\n  }\r\n}\r\n\r\nlet Elems=new Set<Element>();\r\nfunction ScanDom() {\r\n  let lst=document.querySelectorAll(\"[ap-get],[ap-post],[ap-put],[ap-delete]\");\r\n  let NewElems=new Set<Element>();\r\n  for(const el of lst) { \r\n    NewElems.add(el);\r\n    if(Elems.has(el)) continue;\r\n    for(const tp of [\"get\",\"post\",\"put\",\"delete\"]) {\r\n      if(el.hasAttribute(\"ap-\"+tp)) HookUpElem(<HTMLElement>el,tp);\r\n    }\r\n  };\r\n  Elems=NewElems;\r\n}\r\n\r\nlet MyMO=new MutationObserver(ScanDom);\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n  ScanDom();\r\n  MyMO.observe(document,{subtree:true,childList:true});\r\n});\r\n\r\n(<any>globalThis).Apport=Apport;\r\n"],
  "mappings": "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",
  "names": ["Apport", "fo", "ThrowThis", "evtDet", "err", "postBody", "HasFile", "kv", "fo2", "r", "hv", "tEl", "frag", "tmpl", "scripts", "sc", "ns", "attr", "HookUpElem", "el", "tp", "MakeOpt", "rv", "AttrVal", "dataJS", "f", "EvtName", "tagName", "evt", "Elems", "ScanDom", "lst", "NewElems", "MyMO"]
}
